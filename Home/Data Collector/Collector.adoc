= Collector Driver

This document details the `Collector` component, which manages the flow from `Driver`s to output for logging and transmission.

== Core Components

=== IProcess Interface: The Data Decoder

The `IProcess` interface (`IProcess.hpp`) defines a standardized system for processing raw data pulled in by low-level `Driver`s.

[listing]
----
             Driver                 Process                 Collector

           +--------+             +---------+             +-----------+
           |        |             |         |             |           |
           |        |             |         |             |           |
           |        +------------→|         +------------→|           |
           |        |             |         |             |           |
           |        |             |         |             |           |
           +--------+             +---------+             +-----------+
----

== System Overview & Data Flow

=== Data Flow Diagram

The following diagram illustrates the various data sources and their path through processing units before being managed by the `Collector`.

[mermaid]
----
graph LR
    A[ADXL345] --> P1[Proc]
    Sp[Spectronik controller]--> P2[processing]

    cb[CanCallback] --> Can_Throttle
    cb --> Can_Telemetry
    cb --> Can_Motor

    Can_Throttle --> Collect
    Can_Telemetry --> Collect
    Can_Motor --> Collect

    P1 --> Collect[Collector]
    P2[processing] --> Collect
----

=== Data Identifiers

The `Collector` concatenates and logs/transmits processed data. Each distinct data type is identified by a unique prefix generated by its `ILoggable::toString()` method. The following identifiers are sent by the system:

*   `ACC`: Accelerometer data.
*   `SPC`: Spectronik fuel cell data.
*   `MPW`: Motor Power data.
*   `MTL`: Motor Telemetry data.
*   `THR`: Throttle position.

== Output Formatting & Protocol

The `Collector` constructs two distinct output messages from any valid `ILoggable` object.

|===
| Buffer | Purpose & Protocol | Format

| `ESPbuffer`
| For UART transmission to an external module (e.g., ESP32 telemetry). The message is framed with start/stop bytes and includes a 16-bit CRC for data integrity.
| `[START_BYTE][Timestamp][Data][CRC_HIGH][CRC_LOW][STOP_BYTE]`

| `LOGbuffer`
| For local storage (e.g., micro SD card). Each entry is terminated by a newline character.
| `[Timestamp][Data]\n`
|===

=== Example Output

Assuming an `ILoggable` object provides `getSampletimeString()` as `"23:17:42,099"` and `toString()` as `"ACC,-109,32,-229"`.

.Example `ESPbuffer` Content (Conceptual)
[source,text]
----
Byte Stream: 0x01 '2' '3' ':' '1' '7' ':' '4' '2' ',' '0' '9' '9' | 'A' 'C' 'C' ',' '-' '1' '0' '9' ',' '3' '2' ',' '-' '2' '2' '9' 0x12 0x34 0x18
Interpretation: [START] [ Timestamp String ] [ Data String ] [CRC_H] [CRC_L] [STOP]
----

.Example `LOGbuffer` Content
[source,text]
----
23:17:42,099,ACC,-109,32,-229\n
----

== Configuration

The `Collector`'s behavior is influenced by compile-time constants, primarily defined in `Config/Config.hpp`.

*   `Config::collector::buffer_size`: Defines the maximum size of the `ESPbuffer` and `LOGbuffer`.
*   `Config::GNSS::START_BYTE`: The start delimiter byte for UART transmissions.
*   `Config::GNSS::STOP_BYTE`: The stop delimiter byte for UART transmissions.
*   `DATA_SOURCE_COUNT`: A `constexpr` in `collector.hpp` limiting the number of registered `IProcess` and `ILoggable` objects.

== Contact
sjoerd